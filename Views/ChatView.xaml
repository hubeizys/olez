<UserControl
    x:Class="ollez.Views.ChatView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:prism="http://prismlibrary.com/"
    xmlns:converters="clr-namespace:ollez.Converters"
    prism:ViewModelLocator.AutoWireViewModel="True">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="300"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="2*" MinWidth="400"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧聊天记录列表 -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <TextBlock
                Margin="16,16,16,8"
                Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                Text="聊天记录" />

            <ListView
                Grid.Row="1"
                ItemsSource="{Binding ChatSessions}"
                SelectedItem="{Binding CurrentSession}">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Margin="8,4">
                            <TextBlock Text="{Binding Title}" Style="{StaticResource MaterialDesignBody1TextBlock}"/>
                            <TextBlock Text="{Binding LastMessageTime}" Style="{StaticResource MaterialDesignCaptionTextBlock}"/>
                        </StackPanel>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- 分隔线 -->
        <GridSplitter
            Grid.Column="1"
            Width="4"
            HorizontalAlignment="Center"
            VerticalAlignment="Stretch"
            Background="{DynamicResource MaterialDesignDivider}"/>

        <!-- 右侧聊天区域 -->
        <Grid Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 模型选择区域 -->
            <DockPanel Margin="16,16,16,8">
                <Button
                    Margin="8,0,0,0"
                    Command="{Binding RefreshModelsCommand}"
                    DockPanel.Dock="Right"
                    Style="{StaticResource MaterialDesignOutlinedButton}">
                    <materialDesign:PackIcon Kind="Refresh"/>
                </Button>
                <ComboBox
                    materialDesign:HintAssist.Hint="选择模型"
                    ItemsSource="{Binding AvailableModels}"
                    SelectedItem="{Binding SelectedModel}"
                    Style="{StaticResource MaterialDesignOutlinedComboBox}"/>
            </DockPanel>

            <!-- 聊天内容区域 -->
            <ScrollViewer
                x:Name="ChatScrollViewer"
                Grid.Row="1"
                Margin="8"
                VerticalScrollBarVisibility="Auto"
                ScrollChanged="ChatScrollViewer_ScrollChanged">
                <ItemsControl ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- 左侧头像（AI） -->
                                <Border
                                    Grid.Column="0"
                                    Width="40"
                                    Height="40"
                                    Margin="0,0,8,0"
                                    CornerRadius="20"
                                    Background="{DynamicResource MaterialDesignPaper}"
                                    Visibility="{Binding IsUser, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                                    <materialDesign:PackIcon
                                        Kind="Robot"
                                        Width="24"
                                        Height="24"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                                </Border>

                                <!-- 消息气泡 -->
                                <Border
                                    Grid.Column="{Binding IsUser, Converter={StaticResource BooleanTo1Or2Converter}}"
                                    MaxWidth="600"
                                    Margin="4,0"
                                    Padding="12,8"
                                    Background="{Binding IsUser, Converter={StaticResource UserMessageBackgroundConverter}}"
                                    CornerRadius="12"
                                    Effect="{StaticResource MaterialDesignElevationShadow2}">
                                    
                                    <StackPanel>
                                        <!-- 思考状态显示 -->
                                        <TextBlock
                                            Margin="0,0,0,4"
                                            Foreground="{DynamicResource MaterialDesignBodyLight}"
                                            Text="正在思考..."
                                            Visibility="{Binding IsThinking, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                            
                                        <!-- 消息内容 -->
                                        <RichTextBox
                                            IsReadOnly="True"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="0"
                                            VerticalScrollBarVisibility="Auto"
                                            HorizontalScrollBarVisibility="Auto"
                                            Document="{Binding MessageDocument, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                            <RichTextBox.Resources>
                                                <Style TargetType="{x:Type Paragraph}">
                                                    <Setter Property="Margin" Value="0"/>
                                                </Style>
                                            </RichTextBox.Resources>
                                        </RichTextBox>
                                    </StackPanel>
                                </Border>

                                <!-- 右侧头像（用户） -->
                                <Border
                                    Grid.Column="2"
                                    Width="40"
                                    Height="40"
                                    Margin="8,0,0,0"
                                    CornerRadius="20"
                                    Background="{DynamicResource MaterialDesignPaper}"
                                    Visibility="{Binding IsUser, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <materialDesign:PackIcon
                                        Kind="Account"
                                        Width="24"
                                        Height="24"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"/>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- 输入区域 -->
            <Border
                Grid.Row="2"
                Margin="16"
                Padding="16,12"
                Background="{DynamicResource MaterialDesignPaper}"
                CornerRadius="12"
                Effect="{StaticResource MaterialDesignElevationShadow4}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBox
                        x:Name="MessageInput"
                        Margin="0,0,16,0"
                        materialDesign:HintAssist.Hint="输入消息..."
                        materialDesign:TextFieldAssist.HasClearButton="True"
                        Style="{StaticResource MaterialDesignOutlinedTextBox}"
                        Text="{Binding InputMessage, UpdateSourceTrigger=PropertyChanged}"
                        KeyDown="MessageInput_KeyDown"/>

                    <Button
                        Grid.Column="1"
                        Command="{Binding SendMessageCommand}"
                        Style="{StaticResource MaterialDesignFloatingActionButton}">
                        <materialDesign:PackIcon Kind="Send"/>
                    </Button>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>