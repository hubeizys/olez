<?xml version="1.0" encoding="utf-8" ?>
<UserControl x:Class="ollez.Views.SystemSetupView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:prism="http://prismlibrary.com/"
             xmlns:converters="clr-namespace:ollez.Converters"
             prism:ViewModelLocator.AutoWireViewModel="True">

    <UserControl.Resources>
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter"/>
        <converters:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
    </UserControl.Resources>

    <materialDesign:Card Width="600"
                         Margin="16">
        <materialDesign:Transitioner SelectedIndex="{Binding CurrentStep}">
            <!-- 步骤1：NVIDIA驱动和CUDA -->
            <materialDesign:TransitionerSlide
                OpeningEffect="{materialDesign:TransitionEffect SlideInFromLeft, Duration=0:0:0.4}">
                <materialDesign:TransitionerSlide.ForwardWipe>
                    <materialDesign:CircleWipe/>
                </materialDesign:TransitionerSlide.ForwardWipe>
                <Grid Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                               Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                               Text="步骤 1: NVIDIA驱动和CUDA安装"/>

                    <!-- 用户引导提示卡片 -->
                    <materialDesign:Card Grid.Row="1"
                                         Margin="0,16,0,0"
                                         Background="{DynamicResource PrimaryHueMidBrush}"
                                         Foreground="{DynamicResource PrimaryHueMidForegroundBrush}"
                                         UniformCornerRadius="4">
                        <Grid Margin="16,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0"
                                    Style="{StaticResource MaterialDesignFloatingActionMiniLightButton}"
                                    materialDesign:ButtonProgressAssist.IsIndicatorVisible="True"
                                    materialDesign:ButtonProgressAssist.IsIndeterminate="{Binding ShowGuideIndicator}"
                                    materialDesign:ButtonProgressAssist.Value="-1"
                                    Margin="0,0,16,0"
                                    IsEnabled="False">
                                <materialDesign:PackIcon Kind="ArrowRightBold"/>
                            </Button>

                            <TextBlock Grid.Column="1"
                                       Text="{Binding NvidiaGuide}"
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"
                                       VerticalAlignment="Center"
                                       TextWrapping="Wrap"/>
                        </Grid>
                    </materialDesign:Card>

                    <StackPanel Grid.Row="2"
                                Margin="0,16">
                        <!-- 状态卡片 -->
                        <materialDesign:Card Margin="0,0,0,16"
                                             Background="{DynamicResource MaterialDesignBackground}">
                            <Grid Margin="16">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- NVIDIA驱动状态 -->
                                <DockPanel Grid.Row="0">
                                    <materialDesign:PackIcon Kind="ExpansionCard"
                                                             VerticalAlignment="Center"
                                                             Width="24"
                                                             Height="24"
                                                             Margin="0,0,8,0"/>
                                    <TextBlock Text="NVIDIA驱动: "
                                               VerticalAlignment="Center"/>
                                    <TextBlock Margin="8,0,0,0"
                                               VerticalAlignment="Center">
                                        <Run Text="{Binding CudaInfo.DriverVersion, TargetNullValue='未安装'}"
                                             Foreground="{Binding CudaInfo.IsAvailable, Converter={StaticResource BoolToColorConverter}}"/>
                                    </TextBlock>
                                </DockPanel>

                                <!-- CUDA状态 -->
                                <DockPanel Grid.Row="1"
                                           Margin="0,8,0,0">
                                    <materialDesign:PackIcon Kind="Chip"
                                                             VerticalAlignment="Center"
                                                             Width="24"
                                                             Height="24"
                                                             Margin="0,0,8,0"/>
                                    <TextBlock Text="CUDA版本: "
                                               VerticalAlignment="Center"/>
                                    <TextBlock Margin="8,0,0,0"
                                               VerticalAlignment="Center">
                                        <Run Text="{Binding CudaInfo.Version, TargetNullValue='未安装'}"
                                             Foreground="{Binding CudaInfo.IsAvailable, Converter={StaticResource BoolToColorConverter}}"/>
                                    </TextBlock>
                                </DockPanel>

                                <!-- CUDA提示信息 -->
                                <TextBlock Grid.Row="2"
                                           Margin="0,4,0,0"
                                           Foreground="#D32F2F"
                                           TextWrapping="Wrap"
                                           Style="{StaticResource MaterialDesignBody2TextBlock}">
                                    <materialDesign:PackIcon Kind="AlertCircle"
                                                             VerticalAlignment="Center"
                                                             Width="16"
                                                             Height="16"/>
                                    <Run Text="可以不安装CUDA跳过这一步，但会疯狂使用CPU，强烈建议安装CUDA以获得更好的性能"/>
                                </TextBlock>

                                <!-- 本地安装包状态 -->
                                <StackPanel Grid.Row="2"
                                            Margin="0,16,0,0"
                                            Visibility="{Binding HasLocalCudaSetup, Converter={StaticResource BoolToVis}}">
                                    <DockPanel>
                                        <materialDesign:PackIcon Kind="FileCheck"
                                                                 VerticalAlignment="Center"
                                                                 Width="24"
                                                                 Height="24"
                                                                 Margin="0,0,8,0"/>
                                        <TextBlock Text="已检测到本地安装包"
                                                   VerticalAlignment="Center"/>
                                        <Button Content="查看文件"
                                                Command="{Binding OpenLocalSetupFolderCommand}"
                                                Style="{StaticResource MaterialDesignFlatButton}"
                                                Margin="16,0,0,0"/>
                                    </DockPanel>
                                </StackPanel>

                                <!-- 下载状态和进度 -->
                                <StackPanel Grid.Row="2"
                                            Margin="0,16,0,0"
                                            Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}">
                                    <TextBlock Text="{Binding DownloadStatus}"
                                               Style="{StaticResource MaterialDesignBody1TextBlock}"/>
                                    <Grid Margin="0,8,0,0">
                                        <ProgressBar Value="{Binding DownloadProgress}"
                                                     Maximum="1"
                                                     Height="4"/>
                                        <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                                materialDesign:ButtonProgressAssist.IsIndicatorVisible="True"
                                                materialDesign:ButtonProgressAssist.Value="{Binding DownloadProgress}"
                                                materialDesign:ButtonProgressAssist.IsIndeterminate="True"
                                                HorizontalAlignment="Right"
                                                Width="36"
                                                Height="36">
                                            <materialDesign:PackIcon Kind="Download"
                                                                     Width="18"
                                                                     Height="18"/>
                                        </Button>
                                    </Grid>
                                </StackPanel>

                                <!-- 环境变量设置进度 -->
                                <!-- <StackPanel Grid.Row="3" 
                                          Margin="0,16,0,0"
                                          IsEnabled="{Binding IsEnvControlsEnabled}"
                                          Visibility="{Binding CudaInfo.IsAvailable, Converter={StaticResource BoolToVis}}">
                                    <DockPanel>
                                        <TextBlock Text="环境变量设置进度" 
                                                 Style="{StaticResource MaterialDesignBody2TextBlock}"/>
                                        <TextBlock Text="{Binding EnvSetupProgress, StringFormat={}{0}%}"
                                                 HorizontalAlignment="Right"
                                                 Style="{StaticResource MaterialDesignBody2TextBlock}"/>
                                    </DockPanel>
                                    <ProgressBar Value="{Binding EnvSetupProgress}"
                                               Maximum="100"
                                               Height="4"
                                               Margin="0,4,0,0"/>
                                    <Button Content="设置环境变量"
                                           Command="{Binding SetupEnvCommand}"
                                           Style="{StaticResource MaterialDesignRaisedButton}"
                                           HorizontalAlignment="Left"
                                           Margin="0,8,0,0"/>
                                </StackPanel> -->
                            </Grid>
                        </materialDesign:Card>

                        <!-- 操作按钮 -->
                        <materialDesign:Card Background="{DynamicResource MaterialDesignBackground}">
                            <StackPanel Margin="16">

                                <Button Content="下载NVIDIA驱动"
                                        Command="{Binding DownloadNvidiaCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        HorizontalAlignment="Left"
                                        Margin="0,0,0,8"
                                        Visibility="{Binding ShowNvidiaDownloadButton, Converter={StaticResource BoolToVis}}"/>

                                <DockPanel   Visibility="{Binding HasLocalNvidiaSetup, Converter={StaticResource BoolToVis}}">
                                    <Button Content="安装NVIDIA驱动"
                                            Command="{Binding InstallNvidiaCommand}"
                                            Style="{StaticResource MaterialDesignRaisedButton}"
                                            HorizontalAlignment="Left"
                                            Margin="0,0,0,8"/>
                                    <TextBlock Text="已安装，点击重新安装"
                                               Margin="16,0,0,0"
                                               VerticalAlignment="Center"
                                               Foreground="#666666"
                                               Visibility="{Binding CudaInfo.IsAvailable, Converter={StaticResource BoolToVis}}"/>
                                </DockPanel>

                                <Button Content="下载CUDA Toolkit"
                                        Command="{Binding DownloadCudaCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        HorizontalAlignment="Left"
                                        Margin="0,0,0,8"
                                        Visibility="{Binding ShowCudaDownloadButton, Converter={StaticResource BoolToVis}}"/>

                                <DockPanel   Visibility="{Binding HasLocalCudaSetup, Converter={StaticResource BoolToVis}}">
                                    <Button Content="安装CUDA Toolkit"
                                            Command="{Binding InstallCudaCommand}"
                                            Style="{StaticResource MaterialDesignRaisedButton}"
                                            HorizontalAlignment="Left"
                                            Margin="0,0,0,8"/>
                                    <TextBlock Text="已安装，点击重新安装"
                                               Margin="16,0,0,0"
                                               VerticalAlignment="Center"
                                               Foreground="#666666"
                                               Visibility="{Binding CudaInfo.IsAvailable, Converter={StaticResource BoolToVis}}"/>
                                </DockPanel>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>

                    <StackPanel Grid.Row="3"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="0,16,0,0">
                        <Button Content="跳过"
                                Command="{Binding SkipCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Margin="0,0,8,0"/>
                        <Button Content="下一步"
                                Command="{Binding NextCommand}"/>
                    </StackPanel>
                </Grid>
            </materialDesign:TransitionerSlide>

            <!-- 步骤2：Ollama安装 -->
            <materialDesign:TransitionerSlide
                OpeningEffect="{materialDesign:TransitionEffect SlideInFromRight, Duration=0:0:0.4}">
                <materialDesign:TransitionerSlide.BackwardWipe>
                    <materialDesign:CircleWipe/>
                </materialDesign:TransitionerSlide.BackwardWipe>
                <materialDesign:TransitionerSlide.ForwardWipe>
                    <materialDesign:SlideWipe Direction="Up"
                                              Duration="0:0:0.4"/>
                </materialDesign:TransitionerSlide.ForwardWipe>
                <Grid Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                               Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                               Text="步骤 2: Ollama安装"/>

                    <!-- 用户引导提示 -->
                    <materialDesign:Card Grid.Row="1"
                                         Margin="0,16,0,0"
                                         Background="{DynamicResource PrimaryHueMidBrush}"
                                         Foreground="{DynamicResource PrimaryHueMidForegroundBrush}"
                                         UniformCornerRadius="4">
                        <Grid Margin="16,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0"
                                    Style="{StaticResource MaterialDesignFloatingActionMiniLightButton}"
                                    materialDesign:ButtonProgressAssist.IsIndicatorVisible="True"
                                    materialDesign:ButtonProgressAssist.IsIndeterminate="{Binding ShowGuideIndicator}"
                                    materialDesign:ButtonProgressAssist.Value="-1"
                                    Margin="0,0,16,0"
                                    IsEnabled="False">
                                <materialDesign:PackIcon Kind="ArrowRightBold"/>
                            </Button>

                            <TextBlock Grid.Column="1"
                                       Text="{Binding UserGuide}"
                                       Style="{StaticResource MaterialDesignBody1TextBlock}"
                                       VerticalAlignment="Center"
                                       TextWrapping="Wrap"/>
                        </Grid>
                    </materialDesign:Card>

                    <StackPanel Grid.Row="2"
                                Margin="0,16">
                        <!-- 本地安装包状态和操作区域 -->
                        <materialDesign:Card Margin="0,0,0,16"
                                             Background="{DynamicResource MaterialDesignBackground}">
                            <Grid Margin="16">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <!-- 状态显示区域 -->
                                <StackPanel Grid.Row="0"
                                            Orientation="Horizontal"
                                            Visibility="{Binding HasLocalSetup, Converter={StaticResource BoolToVis}}">
                                    <materialDesign:PackIcon Kind="FileCheck"
                                                             VerticalAlignment="Center"
                                                             Width="24"
                                                             Height="24"
                                                             Margin="0,0,8,0"/>
                                    <TextBlock Text="已检测到本地安装包"
                                               Style="{StaticResource MaterialDesignBody1TextBlock}"
                                               VerticalAlignment="Center"/>
                                    <Button Content="看看文件"
                                            Command="{Binding OpenLocalSetupFolderCommand}"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            Margin="16,0,0,0"/>
                                </StackPanel>

                                <!-- 下载状态和进度显示 -->
                                <StackPanel Grid.Row="1"
                                            Margin="0,8,0,0"
                                            Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}">
                                    <TextBlock Text="{Binding DownloadStatus}"
                                               Style="{StaticResource MaterialDesignBody1TextBlock}"/>
                                    <Grid Margin="0,8,0,0">
                                        <ProgressBar Value="{Binding DownloadProgress}"
                                                     Maximum="1"
                                                     Height="4"/>
                                        <Button Style="{StaticResource MaterialDesignFloatingActionMiniButton}"
                                                materialDesign:ButtonProgressAssist.IsIndicatorVisible="True"
                                                materialDesign:ButtonProgressAssist.Value="{Binding DownloadProgress}"
                                                materialDesign:ButtonProgressAssist.IsIndeterminate="True"
                                                HorizontalAlignment="Right"
                                                Width="36"
                                                Height="36">
                                            <materialDesign:PackIcon Kind="Download"
                                                                     Width="18"
                                                                     Height="18"/>
                                        </Button>
                                    </Grid>
                                </StackPanel>
                            </Grid>
                        </materialDesign:Card>

                        <!-- 操作区域 -->
                        <materialDesign:Card Background="{DynamicResource MaterialDesignBackground}">
                            <StackPanel Margin="16">
                                <!-- 下载按钮 -->
                                <Button Content="下载Ollama"
                                        Command="{Binding DownloadOllamaCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        HorizontalAlignment="Left"
                                        Visibility="{Binding ShowOllamaDownloadButton, Converter={StaticResource BoolToVis}}"/>

                                <!-- 安装路径选择 -->
                                <DockPanel Margin="0,16,0,0">
                                    <TextBlock Text="安装路径："
                                               VerticalAlignment="Center"/>
                                    <Button Command="{Binding SelectInstallPathCommand}"
                                            Content="选择路径"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            DockPanel.Dock="Right"/>
                                    <TextBlock Text="{Binding SelectedInstallPath}"
                                               VerticalAlignment="Center"
                                               Margin="8,0"/>
                                </DockPanel>

                                <!-- 模型路径选择 -->
                                <DockPanel Margin="0,16,0,0">
                                    <TextBlock Text="模型路径："
                                               VerticalAlignment="Center"/>
                                    <Button Command="{Binding SelectModelPathCommand}"
                                            Content="选择路径"
                                            Style="{StaticResource MaterialDesignFlatButton}"
                                            DockPanel.Dock="Right"/>
                                    <TextBlock Text="{Binding SelectedModelPath}"
                                               VerticalAlignment="Center"
                                               Margin="8,0"/>
                                </DockPanel>

                                <!-- 安装按钮 -->
                                <Button Content="安装Ollama"
                                        Command="{Binding InstallOllamaCommand}"
                                        Style="{StaticResource MaterialDesignRaisedButton}"
                                        Margin="0,16,0,0"
                                        HorizontalAlignment="Left"
                                        Visibility="{Binding HasLocalSetup, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </materialDesign:Card>
                    </StackPanel>

                    <StackPanel Grid.Row="3"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right"
                                Margin="0,16,0,0">
                        <Button Content="上一步"
                                Command="{Binding PreviousCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Margin="0,0,8,0"/>
                        <Button Content="下一步"
                                Command="{Binding NextCommand}"/>
                    </StackPanel>
                </Grid>
            </materialDesign:TransitionerSlide>

            <!-- 步骤3：下载模型 -->
            <materialDesign:TransitionerSlide
                OpeningEffect="{materialDesign:TransitionEffect SlideInFromTop, Duration=0:0:0.4}">
                <materialDesign:TransitionerSlide.BackwardWipe>
                    <materialDesign:SlideWipe Direction="Down"
                                              Duration="0:0:0.4"/>
                </materialDesign:TransitionerSlide.BackwardWipe>
                <Grid Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0"
                               Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                               Text="步骤 3: 下载模型"/>

                    <!-- 搜索区域 -->
                    <materialDesign:Card Grid.Row="1"
                                         Margin="0,16,0,16">
                        <Grid Margin="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- <TextBox Grid.Row="0"
                                     materialDesign:HintAssist.Hint="搜索 Ollama 模型"
                                     Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                     Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged}">
                                <TextBox.InputBindings>
                                    <KeyBinding Key="Return"
                                                Command="{Binding SearchModelsCommand}"/>
                                </TextBox.InputBindings> -->
                            <!-- </TextBox> -->

                            <ItemsControl Grid.Row="1"
                                          Margin="0,16,0,0"
                                          ItemsSource="{Binding SearchResults}"
                                          Visibility="{Binding HasSearchResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <materialDesign:Card
                                            Margin="4"
                                            MinWidth="150"
                                            Background="{DynamicResource MaterialDesignBackground}">
                                            <Button Style="{StaticResource MaterialDesignFlatButton}"
                                                    Height="Auto"
                                                    Margin="8"
                                                    Command="{Binding DataContext.InstallModelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding ModelName}">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding ModelName}"
                                                               TextWrapping="Wrap"
                                                               HorizontalAlignment="Center"
                                                               Style="{StaticResource MaterialDesignSubtitle1TextBlock}"/>
                                                    <TextBlock Text="{Binding Description}"
                                                               TextWrapping="Wrap"
                                                               HorizontalAlignment="Center"
                                                               Margin="0,4,0,0"
                                                               FontSize="12"/>
                                                </StackPanel>
                                            </Button>
                                        </materialDesign:Card>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </materialDesign:Card>

                    <!-- DeepSeek-R1 模型列表 -->
                    <materialDesign:Card Grid.Row="2"
                                         Margin="0,0,0,16">
                        <StackPanel Margin="16">
                            <TextBlock Text="DeepSeek-R1 系列模型"
                                       Style="{StaticResource MaterialDesignHeadline6TextBlock}"
                                       Margin="0,0,0,16"/>

                            <WrapPanel>
                                <ItemsControl ItemsSource="{Binding DeepseekModels}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <materialDesign:Card
                                                Margin="4"
                                                MinWidth="150"
                                                Background="{DynamicResource MaterialDesignBackground}">
                                                <Grid>
                                                    <ProgressBar
                                                        Height="{Binding ActualHeight, RelativeSource={RelativeSource AncestorType=Grid}}"
                                                        Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=Grid}}"
                                                        Value="{Binding DownloadProgress}"
                                                        Maximum="100"
                                                        Minimum="0"
                                                        IsIndeterminate="False"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}"
                                                        Style="{StaticResource MaterialDesignLinearProgressBar}"/>
                                                    <Button Style="{StaticResource MaterialDesignFlatButton}"
                                                            Height="Auto"
                                                            Margin="8"
                                                            Command="{Binding DataContext.InstallDeepseekModelCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                            CommandParameter="{Binding Size}"
                                                            IsEnabled="{Binding IsInstalled, Converter={StaticResource InverseBooleanConverter}}">
                                                        <StackPanel>
                                                            <TextBlock TextWrapping="Wrap"
                                                                       HorizontalAlignment="Center"
                                                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                                                       Foreground="{Binding IsInstalled, Converter={StaticResource BoolToColorConverter}, ConverterParameter=PrimaryHueMidBrush}">
                                                                <Run Text="DeepSeek-R1"/>
                                                                <Run Text="{Binding Size}"/>
                                                            </TextBlock>
                                                            <TextBlock FontSize="12"
                                                                       Foreground="{Binding IsInstalled, Converter={StaticResource BoolToColorConverter}, ConverterParameter=MaterialDesignBodyLight}"
                                                                       HorizontalAlignment="Center"
                                                                       Margin="0,4,0,0">
                                                                <Run Text="{Binding RequiredVRAM}"/>
                                                                <Run Text="GB VRAM"/>
                                                            </TextBlock>
                                                            <TextBlock Text="已下载"
                                                                     FontSize="12"
                                                                     Foreground="{DynamicResource PrimaryHueMidBrush}"
                                                                     HorizontalAlignment="Center"
                                                                     Margin="0,4,0,0"
                                                                     Visibility="{Binding IsInstalled, Converter={StaticResource BoolToVis}}"/>
                                                            <TextBlock Text="{Binding DownloadProgress, StringFormat={}{0:N0}%}"
                                                                     FontSize="12"
                                                                     Foreground="{DynamicResource PrimaryHueMidBrush}"
                                                                     HorizontalAlignment="Center"
                                                                     Margin="0,4,0,0"
                                                                     Visibility="{Binding IsDownloading, Converter={StaticResource BoolToVis}}"/>
                                                        </StackPanel>
                                                    </Button>
                                                </Grid>
                                            </materialDesign:Card>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </WrapPanel>
                        </StackPanel>
                    </materialDesign:Card>

                    <!-- 下载进度显示 -->
                    <materialDesign:Card Grid.Row="2"
                                         Margin="0,0,0,16"
                                         Visibility="{Binding IsDownloading, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Margin="16">
                            <TextBlock Text="模型下载进度"
                                       Style="{StaticResource MaterialDesignSubtitle1TextBlock}"
                                       Margin="0,0,0,16"/>

                            <TextBlock Text="{Binding DownloadStatus}"
                                       TextWrapping="Wrap"
                                       Margin="0,0,0,8"/>

                            <Grid>
                                <ProgressBar Value="{Binding DownloadProgress}"
                                             Maximum="100"
                                             Height="4"/>
                                <TextBlock Text="{Binding DownloadProgress, StringFormat={}{0:N1}%}"
                                           HorizontalAlignment="Center"
                                           Margin="0,8,0,0"/>
                            </Grid>

                            <!-- 命令行输出 -->
                            <Border Margin="0,16,0,0"
                                    BorderBrush="{DynamicResource MaterialDesignDivider}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                <ScrollViewer MaxHeight="200"
                                              VerticalScrollBarVisibility="Auto">
                                    <TextBlock Text="{Binding CommandOutput}"
                                               FontFamily="Consolas"
                                               Padding="8"
                                               TextWrapping="Wrap"/>
                                </ScrollViewer>
                            </Border>
                        </StackPanel>
                    </materialDesign:Card>

                    <StackPanel Grid.Row="3"
                                Orientation="Horizontal"
                                HorizontalAlignment="Right">
                        <Button Content="上一步"
                                Command="{Binding PreviousCommand}"
                                Style="{StaticResource MaterialDesignOutlinedButton}"
                                Margin="0,0,8,0"/>
                        <Button Content="完成"
                                Command="{Binding NextCommand}"/>
                    </StackPanel>
                </Grid>
            </materialDesign:TransitionerSlide>
        </materialDesign:Transitioner>
    </materialDesign:Card>
</UserControl> 